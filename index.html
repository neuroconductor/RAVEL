<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Removal of Artificial Voxel Effect by Linear Regression • RAVEL</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Removal of Artificial Voxel Effect by Linear Regression">
<meta property="og:description" content="Removal of artificial voxel effect by linear regression.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">RAVEL</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.2.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/ravel.html">Working with RAVEL</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Jfortin1/RAVEL/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div id="ravel" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#ravel" class="anchor" aria-hidden="true"></a>RAVEL</h1></div>
<!-- ![Sticker](sticker.png) -->
<p><img src="sticker.png" width="100"></p>
<div id="intensity-normalizations-for-structural-mris" class="section level3">
<h3 class="hasAnchor">
<a href="#intensity-normalizations-for-structural-mris" class="anchor" aria-hidden="true"></a>Intensity normalizations for structural MRIs</h3>
<p><strong>Creator</strong>: Jean-Philippe Fortin, <a href="mailto:fortin946@gmail.com" class="email">fortin946@gmail.com</a></p>
<p><strong>Authors</strong>: Jean-Philippe Fortin, John Muschelli, Russell T. Shinohara</p>
<p><strong>License</strong>: GPL-2</p>
<div id="software-status" class="section level5">
<h5 class="hasAnchor">
<a href="#software-status" class="anchor" aria-hidden="true"></a>Software status</h5>
<table class="table">
<thead><tr class="header">
<th>Resource:</th>
<th>Travis CI</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Platform:</td>
<td>OSX</td>
</tr>
<tr class="even">
<td>R CMD check</td>
<td><a href="https://travis-ci.org/Jfortin1/RAVEL" class="external-link"><img src="https://travis-ci.org/Jfortin1/RAVEL.svg?branch=master" alt="Build status"></a></td>
</tr>
</tbody>
</table>
</div>
<div id="references" class="section level5">
<h5 class="hasAnchor">
<a href="#references" class="anchor" aria-hidden="true"></a>References</h5>
<table class="table">
<colgroup>
<col width="2%">
<col width="82%">
<col width="15%">
</colgroup>
<thead><tr class="header">
<th>Method</th>
<th>Citation</th>
<th>Paper Link</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>RAVEL</td>
<td>Jean-Philippe Fortin, Elizabeth M Sweeney, John Muschelli, Ciprian M Crainiceanu, Russell T Shinohara, Alzheimer’s Disease Neuroimaging Initiative, et al. <strong>Removing inter-subject technical variability in magnetic resonance imaging studies</strong>. NeuroImage, 132:198–212, 2016.</td>
<td><a href="http://www.sciencedirect.com/science/article/pii/S1053811916001452" class="external-link">Link</a></td>
</tr>
<tr class="even">
<td>WhiteStripe</td>
<td>Russell T Shinohara, Elizabeth M Sweeney, Jeff Goldsmith, Navid Shiee, Farrah J Mateen, Peter A Calabresi, Samson Jarso, Dzung L Pham, Daniel S Reich, Ciprian M Crainiceanu, Australian Imaging Biomarkers Lifestyle Flagship Study of Ageing, and Alzheimer’s Disease Neuroimaging Initiative. <strong>Statistical normalization techniques for magnetic resonance imaging</strong>. Neuroimage Clin, 6:9–19, 2014.</td>
<td><a href="http://www.sciencedirect.com/science/article/pii/S221315821400117X" class="external-link">Link</a></td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="table-of-content" class="section level2">
<h2 class="hasAnchor">
<a href="#table-of-content" class="anchor" aria-hidden="true"></a>Table of content</h2>
<ul>
<li><a href="#id-section1">1. Introduction</a></li>
<li><a href="#id-section2">2. Image preprocessing</a></li>
<li><a href="#id-section3">3. Intensity normalization and RAVEL correction</a></li>
</ul>
</div>
<div id="1-introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#1-introduction" class="anchor" aria-hidden="true"></a>1. Introduction</h2>
<p>RAVEL is an R package that combines the preprocessing and statistical analysis of magnetic resonance imaging (MRI) datasets within one framework. Users can start with raw images in the NIfTI format, and end up with a variety of statistical results associated with voxels and regions of interest (ROI) in the brain. RAVEL stands for <em>Removal of Artificial Voxel Effect by Linear regression</em>, the main preprocessing function of the package that allows an effective removal of between-scan unwanted variation. We have shown in <a href="http://www.sciencedirect.com/science/article/pii/S1053811916001452" class="external-link">a recent paper</a> that RAVEL improves significantly population-wide statistical inference. RAVEL is now part of the <a href="https://neuroconductor.org/" class="external-link">Neuroconductor project</a>.</p>
<div id="installation" class="section level5">
<h5 class="hasAnchor">
<a href="#installation" class="anchor" aria-hidden="true"></a>Installation</h5>
<p>You can install RAVEL from github with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages("devtools")</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"jfortin1/RAVEL"</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="2-image-preprocessing" class="section level2">
<h2 class="hasAnchor">
<a href="#2-image-preprocessing" class="anchor" aria-hidden="true"></a>2. Image preprocessing</h2>
<p>We present a pre-normalization preprocessing pipeline implemented in the R software, from raw images to images ready for intensity normalization and statistical analysis. Once the images are preprocessed, users can apply their favorite intensity normalization and the scan-effect correction tool RAVEL as presented in Section 1 above. We present a preprocessing pipeline that uses the R packages <code>ANTsR</code> and <code>fslr</code>. While we have chosen to use a specific template space (JHU-MNI-ss), a specific registration (non-linear diffeomorphic registration) and a specific tissue segmentation (FSL FAST), users can choose other algorithms prior to intensity normalization and in order for RAVEL to work. The only requirement is that the images are registered to the same template space.</p>
<div id="21-prelude" class="section level3">
<h3 class="hasAnchor">
<a href="#21-prelude" class="anchor" aria-hidden="true"></a>2.1. Prelude</h3>
<p>To preprocess the images, we use the packages <code>fslr</code> and <code>ANTsR</code>. The package <code>fslr</code> is available on CRAN, and requires FSL to be installed on your machine; see the <a href="http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/" class="external-link">FSL website</a> for installation. For <code>ANTsR</code>, we recommend to install the latest stable version available at the ANTsR <a href="https://github.com/stnava/ANTsR/releases/" class="external-link">GitHub page</a>. The version used for this vignette was <code>ANTsR_0.3.2.tgz</code>. For the template space, we use the JHU-MNI-ss atlas (see Section 1.2) included in the <code>EveTemplate</code> package, available on GitHub at <a href="https://github.com/Jfortin1/EveTemplate" class="external-link uri">https://github.com/Jfortin1/EveTemplate</a>. For data examples, we use 4 T1-w scans from the package <code>RAVELData</code> available on GitHub at <a href="https://github.com/Jfortin1/RAVELData" class="external-link uri">https://github.com/Jfortin1/RAVELData</a>. Once the packages are properly installed, we are ready to start our preprocessing of T1-w images. We first load the packages into R:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">fslr</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ANTsR</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">RAVELData</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.slicer.org/publications/item/view/1883" class="external-link">EveTemplate</a></span><span class="op">)</span>
<span class="fu">have.fsl</span><span class="op">(</span><span class="op">)</span> <span class="co"># Should be TRUE if fsl is correctly installed</span></code></pre></div>
<p>and let’s specify the path for the different files that we will need:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># JHU-MNI-ss template:</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.slicer.org/publications/item/view/1883" class="external-link">EveTemplate</a></span><span class="op">)</span>
<span class="va">template_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/EveTemplate/man/getEvePath.html" class="external-link">getEvePath</a></span><span class="op">(</span><span class="st">"T1"</span><span class="op">)</span>
<span class="co"># JHU-MNI-ss template brain mask:</span>
<span class="va">template_brain_mask_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/EveTemplate/man/getEvePath.html" class="external-link">getEvePath</a></span><span class="op">(</span><span class="st">"Brain_Mask"</span><span class="op">)</span>
<span class="co"># Example of T1-w MPRAGE image</span>
<span class="va">scan_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span>package<span class="op">=</span><span class="st">"RAVELData"</span>, <span class="st">"data/scan1.nii.gz"</span><span class="op">)</span></code></pre></div>
</div>
<div id="22-jhu-mni-ss-template-_eve_-atlas" class="section level3">
<h3 class="hasAnchor">
<a href="#22-jhu-mni-ss-template-_eve_-atlas" class="anchor" aria-hidden="true"></a>2.2. JHU-MNI-ss template (_EVE_ atlas)</h3>
</div>
<div id="23-registration-to-template" class="section level3">
<h3 class="hasAnchor">
<a href="#23-registration-to-template" class="anchor" aria-hidden="true"></a>2.3. Registration to template</h3>
<p>Tp perform a non-linear registration to the JHU-MNI-ss template, one can use the diffeomorphism algorithm via the <code>ANTsR</code> package. Note that we perform the registration with the skulls on. Here is an example where we register the scan1 from the <code>RAVELData</code> package to the JHU-MNI-ss template:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ANTsRCore</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ANTsR</span><span class="op">)</span>
<span class="va">template</span>    <span class="op">&lt;-</span> <span class="fu">antsImageRead</span><span class="op">(</span><span class="va">template_path</span>, <span class="fl">3</span><span class="op">)</span>
<span class="va">scan</span> <span class="op">&lt;-</span> <span class="fu">antsImageRead</span><span class="op">(</span><span class="va">scan_path</span>,<span class="fl">3</span><span class="op">)</span>
<span class="va">outprefix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">".nii.gz"</span>,<span class="st">""</span>,<span class="va">scan_path</span><span class="op">)</span> <span class="co"># Prefix for the output files</span>
<span class="va">output</span> <span class="op">&lt;-</span> <span class="fu">antsRegistration</span><span class="op">(</span>fixed <span class="op">=</span> <span class="va">template</span>, moving <span class="op">=</span> <span class="va">scan</span>, typeofTransform <span class="op">=</span> <span class="st">"SyN"</span>,  outprefix <span class="op">=</span> <span class="va">outprefix</span><span class="op">)</span>
<span class="va">scan_reg</span>   <span class="op">&lt;-</span> <span class="fu">antsImageClone</span><span class="op">(</span><span class="va">output</span><span class="op">$</span><span class="va">warpedmovout</span><span class="op">)</span> <span class="co"># Registered brain</span></code></pre></div>
<p>The object <code>scan_reg</code> contains the scan registed to the template. Note that the object is in the <code>ANTsR</code> format. Since I prefer to work with the <code>oro.nifti</code> package, which is compatible with <code>flsr</code>, I convert the object to a <code>nifti</code> object using the function <code>ants2oro</code> as follows:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># devtools::install_github("muschellij2/extrantsr")</span>
<span class="co"># or</span>
<span class="co"># source("https://neuroconductor.org/sites/default/files/neurocLite.R")</span>
<span class="co"># neuro_install("extrantsr")</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">extrantsr</span><span class="op">)</span>
<span class="va">scan_reg</span> <span class="op">&lt;-</span> <span class="fu">extrantsr</span><span class="fu">::</span><span class="fu">ants2oro</span><span class="op">(</span><span class="va">scan_reg</span><span class="op">)</span></code></pre></div>
<p>I can save the registered brain in the NIfTi format using the <code>writeNIfTI</code> command:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/oro.nifti/man/write_nifti.html" class="external-link">writeNIfTI</a></span><span class="op">(</span><span class="va">scan_reg</span>, <span class="st">"scan_reg"</span><span class="op">)</span></code></pre></div>
<p>Since <code>scan_reg</code> is converted to a <code>nifti</code> object, we can use the function <code>ortho2</code> from the <code>fslr</code> package to visualize the scan:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ortho2</span><span class="op">(</span><span class="va">scan_reg</span>, crosshairs<span class="op">=</span><span class="cn">FALSE</span>, mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span>, add.orient<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
</div>
<div id="24-intensity-inhomogeneity-correction" class="section level3">
<h3 class="hasAnchor">
<a href="#24-intensity-inhomogeneity-correction" class="anchor" aria-hidden="true"></a>2.4. Intensity inhomogeneity correction</h3>
<p>We perform intensity inhomogeneity correction on the registered scan using the N4 Correction from the <code>ANTsR</code> package:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scan_reg</span> <span class="op">&lt;-</span> <span class="fu">extrantsr</span><span class="fu">::</span><span class="fu">oro2ants</span><span class="op">(</span><span class="va">scan_reg</span><span class="op">)</span> <span class="co"># Convert to ANTsR object</span>
<span class="va">scan_reg_n4</span> <span class="op">&lt;-</span> <span class="fu">n4BiasFieldCorrection</span><span class="op">(</span><span class="va">scan_reg</span><span class="op">)</span>
<span class="va">scan_reg_n4</span> <span class="op">&lt;-</span> <span class="fu">extrantsr</span><span class="fu">::</span><span class="fu">ants2oro</span><span class="op">(</span><span class="va">scan_reg_n4</span><span class="op">)</span> <span class="co"># Conversion to nifti object for further processing</span></code></pre></div>
</div>
<div id="25-skull-stripping" class="section level3">
<h3 class="hasAnchor">
<a href="#25-skull-stripping" class="anchor" aria-hidden="true"></a>2.5. Skull stripping</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">template_brain_mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/oro.nifti/man/read_nifti.html" class="external-link">readNIfTI</a></span><span class="op">(</span><span class="va">template_brain_mask_path</span>, reorient<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="va">scan_reg_n4_brain</span> <span class="op">&lt;-</span> <span class="fu">niftiarr</span><span class="op">(</span><span class="va">scan_reg_n4</span>, <span class="va">scan_reg_n4</span><span class="op">*</span><span class="va">template_brain_mask</span><span class="op">)</span>
<span class="fu">ortho2</span><span class="op">(</span><span class="va">scan_reg_n4_brain</span>, crosshairs<span class="op">=</span><span class="cn">FALSE</span>, mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span>, add.orient<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
</div>
<div id="26-tissue-segmentation" class="section level3">
<h3 class="hasAnchor">
<a href="#26-tissue-segmentation" class="anchor" aria-hidden="true"></a>2.6. Tissue Segmentation</h3>
<p>There are different tissue segmentation algorithms available in R. My favorite is the FSL FAST segmentation via the <a href="https://cran.r-project.org/web/packages/fslr/index.html" class="external-link"><code>fslr</code></a> package. Let’s produce the tissue segmentation for the <code>scan_reg_n4_brain</code> scan above:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ortho2</span><span class="op">(</span><span class="va">scan_reg_n4_brain</span>, crosshairs<span class="op">=</span><span class="cn">FALSE</span>, mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span>, add.orient<span class="op">=</span><span class="cn">FALSE</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">400</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The last line of code produces via the <code>ortho2</code> function from the <code>fslr</code> package the following visualization of the template:</p>
<p align="center">
</p>
<p><img src="images/template.png" width="600"></p>

<p>We perform a 3-class tissue segmentation on the T1-w image with the FAST segmentation algorithm:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scan_reg_n4_brain_seg</span> <span class="op">&lt;-</span> <span class="fu">fast</span><span class="op">(</span><span class="va">scan_reg_n4_brain</span>, verbose<span class="op">=</span><span class="cn">FALSE</span>, opts<span class="op">=</span><span class="st">"-t 1 -n 3"</span><span class="op">)</span> 
<span class="fu">ortho2</span><span class="op">(</span><span class="va">scan_reg_n4_brain_seg</span>, crosshairs<span class="op">=</span><span class="cn">FALSE</span>, mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span>, add.orient<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p align="center">
</p>
<p><img src="images/seg.png" width="600"></p>

<p>The object <code>scan_reg_n4_brain_seg</code> is an image that contains the segmentation labels <code>0,1,2</code> and <code>3</code> referring to Background, CSF, GM and WM voxels respectively.</p>
</div>
<div id="27-creation-of-a-tissue-mask" class="section level3">
<h3 class="hasAnchor">
<a href="#27-creation-of-a-tissue-mask" class="anchor" aria-hidden="true"></a>2.7. Creation of a tissue mask</h3>
<p>Suppose we want to create a mask for CSF.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scan_reg_n4_brain_csf_mask</span> <span class="op">&lt;-</span> <span class="va">scan_reg_n4_brain_seg</span>
<span class="va">scan_reg_n4_brain_csf_mask</span><span class="op">[</span><span class="va">scan_reg_n4_brain_csf_mask</span><span class="op">!=</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="fu">ortho2</span><span class="op">(</span><span class="va">scan_reg_n4_brain_csf_mask</span>, crosshairs<span class="op">=</span><span class="cn">FALSE</span>, mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span>, add.orient<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>We use the fact that the file <code>scan_reg_n4_brain_seg</code> is equal to 1 for CSF, 2 for GM and 3 for WM. FOr instance, a WM mask could be created as follows:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scan_reg_n4_brain_wm_mask</span> <span class="op">&lt;-</span> <span class="va">scan_reg_n4_brain_seg</span>
<span class="va">scan_reg_n4_brain_wm_mask</span><span class="op">[</span><span class="va">scan_reg_n4_brain_wm_mask</span><span class="op">!=</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="fu">ortho2</span><span class="op">(</span><span class="va">scan_reg_n4_brain_wm_mask</span>, crosshairs<span class="op">=</span><span class="cn">FALSE</span>, mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span>, add.orient<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="3-intensity-normalization-and-ravel-correction" class="section level2">
<h2 class="hasAnchor">
<a href="#3-intensity-normalization-and-ravel-correction" class="anchor" aria-hidden="true"></a>3. Intensity normalization and RAVEL correction</h2>
<p>Since MRI intensities are acquired in arbitrary units, image intensities are not comparable across scans, between subjects and across sites. Intensity normalization (or intensity standardization) is paramount before performing between-subject intensity comparisons. The <code>RAVEL</code> package includes the popular histogram matching normalization (<code>normalizeHM</code>) as well as the White Stripe normalization (<code>normalizeWS</code>); see the table below for the reference papers. Once the images intensities are normalized, the RAVEL correction tool can be applied using the function <code>normalizeRAVEL</code> to remove additional unwanted variation using a control region. Because we have found that the combination White Stripe + RAVEL was best at removing unwanted variation, the function <code>normalizeRAVEL</code> performs White Stripe normalization by default prior to the RAVEL correction.</p>
<p>Note: registration is also called <em>spatial normalization</em> which is unrelated to <em>intensity normalization</em>.</p>
<div id="available-methods" class="section level5">
<h5 class="hasAnchor">
<a href="#available-methods" class="anchor" aria-hidden="true"></a>Available methods</h5>
<table class="table">
<thead><tr class="header">
<th>Function</th>
<th>Method</th>
<th>Modalities supported at the moment</th>
<th>Paper Link</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>normalizeRaw</code></td>
<td>No normalization</td>
<td>T1, T2, FLAIR, PD</td>
<td></td>
</tr>
<tr class="even">
<td><code>normalizeRAVEL</code></td>
<td>RAVEL</td>
<td>T1, T2, FLAIR</td>
<td><a href="http://www.sciencedirect.com/science/article/pii/S1053811916001452" class="external-link">Link</a></td>
</tr>
<tr class="odd">
<td><code>normalizeWS</code></td>
<td>White Stripe</td>
<td>T1, T2, FLAIR</td>
<td><a href="http://www.sciencedirect.com/science/article/pii/S221315821400117X" class="external-link">Link</a></td>
</tr>
<tr class="even">
<td><code>normalizeHM</code></td>
<td>Histogram Matching</td>
<td>T1, T2</td>
<td><a href="http://www.ncbi.nlm.nih.gov/pubmed/10571928" class="external-link">Link</a></td>
</tr>
</tbody>
</table>
<p>Briefly, each function takes as input a list of NIfTI file paths specifying the images to be normalized, and return a matrix of normalized intensities where rows are voxels and columns are scans. We note that the input files must be the files associated with preprocessed images registered to a common template. The different functions are described below.</p>
</div>
<div id="31-no-normalization" class="section level3">
<h3 class="hasAnchor">
<a href="#31-no-normalization" class="anchor" aria-hidden="true"></a>3.1 No normalization</h3>
<p>The function <code>normalizeRaw</code> takes as input the preprocessed and registered images, and create a matrix of voxel intensities without intensity normalization. For conventional MRI images, we recommend to apply an intensity normalization to the images (see <code>normalizeWS</code> or <code>normalizeRAVEL</code>). The main purpose of the function <code>normalizeRaw</code> is for exploration data analysis (EDA), methods development and methods comparison.</p>
<table class="table">
<colgroup>
<col width="8%">
<col width="86%">
<col width="4%">
</colgroup>
<thead><tr class="header">
<th>Argument</th>
<th>Description</th>
<th>Default</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>input.files</code></td>
<td>
<code>vector</code> or <code>list</code> of the paths for the input NIfTI image files to be normalized</td>
<td></td>
</tr>
<tr class="even">
<td><code>output.files</code></td>
<td>Optionnal <code>vector</code> or <code>list</code> of the paths for the output images. By default, will be the <code>input.files</code> with “_RAW” appended at the end.</td>
<td><code>NULL</code></td>
</tr>
<tr class="odd">
<td><code>brain.mask</code></td>
<td>NIfTI image path for the binary brain mask. Must have value <code>1</code> for the brain and <code>0</code> otherwise</td>
<td></td>
</tr>
<tr class="even">
<td><code>returnMatrix</code></td>
<td>Should the matrix of normalized images be returned? Rows correspond to voxels specified by <code>brain.mask</code>, and columns correspond to scans.</td>
<td><code>TRUE</code></td>
</tr>
<tr class="odd">
<td><code>writeToDisk</code></td>
<td>Should the normalized images be saved to the disk as NIfTI files?</td>
<td><code>FALSE</code></td>
</tr>
<tr class="even">
<td><code>verbose</code></td>
<td>Should the function be verbose?</td>
<td><code>TRUE</code></td>
</tr>
</tbody>
</table>
</div>
<div id="32-white-stripe-normalization" class="section level3">
<h3 class="hasAnchor">
<a href="#32-white-stripe-normalization" class="anchor" aria-hidden="true"></a>3.2 White Stripe normalization</h3>
<p>The function <code>normalizeWS</code> takes as input the preprocessed and registered images, applies the White Stripe normalization algorith to each image separately via the <code>WhiteStripe</code> R package, and creates a matrix of normalized voxel intensities. Note that the White Stripe normalization is also included as a first step in the RAVEL algorithm implemented in the <code>normalizeRAVEL</code> function.</p>
<table class="table">
<colgroup>
<col width="11%">
<col width="84%">
<col width="4%">
</colgroup>
<thead><tr class="header">
<th>Argument</th>
<th>Description</th>
<th>Default</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>input.files</code></td>
<td>
<code>vector</code> or <code>list</code> of the paths for the input NIfTI image files to be normalized</td>
<td></td>
</tr>
<tr class="even">
<td><code>output.files</code></td>
<td>Optionnal <code>vector</code> or <code>list</code> of the paths for the output images. By default, will be the <code>input.files</code> with “_WS” appended at the end.</td>
<td><code>NULL</code></td>
</tr>
<tr class="odd">
<td><code>brain.mask</code></td>
<td>NIfTI image path for the binary brain mask. Must have value <code>1</code> for the brain and <code>0</code> otherwise</td>
<td></td>
</tr>
<tr class="even">
<td><code>WhiteStripe_Type</code></td>
<td>What is the type of images to be normalized? Must be one of “T1”, “T2” and “FLAIR”.</td>
<td><code>T1</code></td>
</tr>
<tr class="odd">
<td><code>returnMatrix</code></td>
<td>Should the matrix of normalized images be returned? Rows correspond to voxels specified by <code>brain.mask</code>, and columns correspond to scans.</td>
<td><code>TRUE</code></td>
</tr>
<tr class="even">
<td><code>writeToDisk</code></td>
<td>Should the normalized images be saved to the disk as NIfTI files?</td>
<td><code>FALSE</code></td>
</tr>
<tr class="odd">
<td><code>verbose</code></td>
<td>Should the function be verbose?</td>
<td><code>TRUE</code></td>
</tr>
</tbody>
</table>
</div>
<div id="33-histogram-matching-normalization" class="section level3">
<h3 class="hasAnchor">
<a href="#33-histogram-matching-normalization" class="anchor" aria-hidden="true"></a>3.3 Histogram matching normalization</h3>
<p>Not ready yet.</p>
</div>
<div id="34-ravel-normalization" class="section level3">
<h3 class="hasAnchor">
<a href="#34-ravel-normalization" class="anchor" aria-hidden="true"></a>3.4 RAVEL normalization</h3>
<p>The function <code>normalizeRAVEL</code> takes as input the preprocessed and registered images, and a control region mask, and applies the RAVEL correction method to create a matrix of normalized voxel intensities. The White Stripe normalization is included by default as a first step in the RAVEL algorithm. The next section explains how to create a control region mask.</p>
<table class="table">
<colgroup>
<col width="8%">
<col width="88%">
<col width="3%">
</colgroup>
<thead><tr class="header">
<th>Argument</th>
<th>Description</th>
<th>Default</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>input.files</code></td>
<td>
<code>vector</code> or <code>list</code> of the paths for the input NIfTI image files to be normalized</td>
<td></td>
</tr>
<tr class="even">
<td><code>output.files</code></td>
<td>Optionnal <code>vector</code> or <code>list</code> of the paths for the output images. By default, will be the <code>input.files</code> with “_RAVEL” appended at the end.</td>
<td><code>NULL</code></td>
</tr>
<tr class="odd">
<td><code>brain.mask</code></td>
<td>NIfTI image path for the binary brain mask. Must have value <code>1</code> for the brain and <code>0</code> otherwise</td>
<td></td>
</tr>
<tr class="even">
<td><code>control.mask</code></td>
<td>NIfTI image path for the binary control region mask. Must have value <code>1</code> for the control region and <code>0</code> otherwise. See the helper function <code>mask_intersect</code> for the creation of a <code>control.mask</code>.</td>
<td></td>
</tr>
<tr class="odd">
<td><code>WhiteStripe</code></td>
<td>Should White Stripe normalization be performed before RAVEL?</td>
<td><code>TRUE</code></td>
</tr>
<tr class="even">
<td><code>WhiteStripe_Type</code></td>
<td>If <code>WhiteStripe</code> is <code>TRUE</code>, what is the type of images to be normalized? Must be one of “T1”, “T2” and “FLAIR”.</td>
<td><code>T1</code></td>
</tr>
<tr class="odd">
<td><code>k</code></td>
<td>Integer specifying the number of principal components to be included in the RAVEL correction.</td>
<td><code>1</code></td>
</tr>
<tr class="even">
<td><code>returnMatrix</code></td>
<td>Should the matrix of normalized images be returned? Rows correspond to voxels specified by <code>brain.mask</code>, and columns correspond to scans.</td>
<td><code>TRUE</code></td>
</tr>
<tr class="odd">
<td><code>writeToDisk</code></td>
<td>Should the normalized images be saved to the disk as NIfTI files?</td>
<td><code>FALSE</code></td>
</tr>
<tr class="even">
<td><code>verbose</code></td>
<td>Should the function be verbose?</td>
<td><code>TRUE</code></td>
</tr>
</tbody>
</table>
</div>
<div id="35-creation-of-a-control-region-for-ravel" class="section level3">
<h3 class="hasAnchor">
<a href="#35-creation-of-a-control-region-for-ravel" class="anchor" aria-hidden="true"></a>3.5 Creation of a control region for RAVEL</h3>
<p>RAVEL uses a control region of the brain to infer unwanted variation across subjects. The control region is made of voxels known to be <strong>not</strong> associated with the phenotype of interest. For instance, it is known that CSF intensities on T1-w images are not associated with the progression of AD. The control region must be specified in the argument <code>control.mask</code> of the function <code>normalizeRAVEL</code> as a path to a NIfTI file storing a binary mask. In the case of a CSF control region, one way to create such a binary mask is to create a CSF binary mask for each image, and then to take the intersection of all those binary masks. This can be done with the function <code>maskIntersect</code>. The function takes as input a list of binary masks (either <code>nifti</code> objects or a list of NIfTI file paths), and will output the intersection of all the binary masks. By default, the function will save the intersection mask to the disk as a NIfTI file, as specified by <code>output.file</code>:</p>
<p>Example:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/maskIntersect.html">maskIntersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"csf_mask1.nii.gz"</span>, <span class="st">"csf_mask2.nii.gz"</span>, <span class="st">"csf_mask3.nii.gz"</span><span class="op">)</span>,
    output.file<span class="op">=</span><span class="st">"intersection_mask.nii.gz"</span><span class="op">)</span></code></pre></div>
<p>When the number of subjects is large, the intersection mask may be empty, as a consequence of anatomical variation between subjects. As a solution, the function <code>maskIntersect</code> has the option to create an intersection mask that is less stringent by requiring the control region to be present in only a given percentage of the subjects, using the option <code>prob</code>. By default, <code>prob</code> is equal to 1, meaning 100% of the subjects has the final voxels labelled as CSF. For instance, to require that the final control region is shared for at least 90% of the subjects, one would type</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/maskIntersect.html">maskIntersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"csf_mask1.nii.gz"</span>, <span class="st">"csf_mask2.nii.gz"</span>, <span class="st">"csf_mask3.nii.gz"</span><span class="op">)</span>,
    output.file<span class="op">=</span><span class="st">"intersection_mask.nii.gz"</span>, prob<span class="op">=</span><span class="fl">0.9</span><span class="op">)</span></code></pre></div>
<p>For studies with a small number of subjects, the opposite problem may arise: too many voxels labelled as CSF, close to the skull, might be retained in the final intersection mask. Mask erosion, for instance using <a href="https://github.com/muschellij2/fslr" class="external-link">fslr</a>, may be performed to remove such voxels and refine the control mask.</p>
<p>Logo from: <a href="https://openclipart.org/detail/14743/violin-bow" class="external-link uri">https://openclipart.org/detail/14743/violin-bow</a></p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li>Browse source code at <br><a href="https://github.com/Jfortin1/RAVEL/">https://​github.com/​Jfortin1/​RAVEL/​</a>
</li>
<li>Report a bug at <br><a href="https://github.com/Jfortin1/RAVEL/issues">https://​github.com/​Jfortin1/​RAVEL/​issues</a>
</li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="https://www.r-project.org/Licenses/GPL-2">GPL-2</a></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html">Citing RAVEL</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Jean-Philippe Fortin <br><small class="roles"> Maintainer </small>  </li>
</ul>
</div>



  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by Jean-Philippe Fortin.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 1.6.1.9001.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
